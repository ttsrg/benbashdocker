FROM  centos:7.6.1810

ARG APP_VER
ARG JAVA_VER
ARG CONTAINER_USER

RUN yum -y update && yum install -y java-$JAVA_VER-openjdk git wget &&\
    yum clean all

COPY gerritCentosDocfile /

RUN adduser $CONTAINER_USER
USER $CONTAINER_USER
WORKDIR  /home/gerrit/
RUN mkdir -p gerrit/etc && touch gerrit/etc/gerrit.config &&\
    wget -O gerrit.war  https://gerrit-releases.storage.googleapis.com/gerrit-$APP_VER.war &>/dev/null &&\
    java -jar gerrit.war init --batch -d gerrit/ &&\
    rm -rf gerrit.war &&\
    gerrit/bin/gerrit.sh stop


#feature
ADD --chown=$CONTAINER_USER files/gerrit.config gerrit/etc/
COPY  --chown=$CONTAINER_USER files/secure.config gerrit/etc/

EXPOSE 8080
USER $CONTAINER_USER

#VOLUME ["gerrit/git", "gerrit/index", "gerrit/cache", "gerrit/etc"]
ENTRYPOINT ["/home/gerrit/gerrit/bin/gerrit.sh"]
CMD ["run"]
